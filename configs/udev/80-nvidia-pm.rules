# NVIDIA GPU power management rules for hybrid setup
# Automatically manage NVIDIA GPU power state based on usage and power source

# NVIDIA GPU PCI device detection (vendor ID 0x10de, VGA class 0x030000)
# Enable runtime power management for NVIDIA GPU
ACTION=="add", SUBSYSTEM=="pci", ATTR{vendor}=="0x10de", ATTR{class}=="0x030000", TEST=="power/control", ATTR{power/control}="auto"

# Set aggressive power management for NVIDIA GPU
ACTION=="add", SUBSYSTEM=="pci", ATTR{vendor}=="0x10de", ATTR{class}=="0x030000", ATTR{power/autosuspend_delay_ms}="1000"

# Enable runtime PM for NVIDIA GPU audio device (if present)
ACTION=="add", SUBSYSTEM=="pci", ATTR{vendor}=="0x10de", ATTR{class}=="0x040300", TEST=="power/control", ATTR{power/control}="auto"

# Battery power management - turn off NVIDIA GPU when on battery
SUBSYSTEM=="power_supply", ATTR{online}=="0", ENV{POWER_SUPPLY_TYPE}=="Mains", RUN+="/usr/local/bin/bbswitch-control off"

# AC power management - allow NVIDIA GPU to be used when on AC
SUBSYSTEM=="power_supply", ATTR{online}=="1", ENV{POWER_SUPPLY_TYPE}=="Mains", RUN+="/usr/local/bin/bbswitch-control auto"

# USB device power management for better battery life
ACTION=="add", SUBSYSTEM=="usb", TEST=="power/control", ATTR{power/control}="auto"
ACTION=="add", SUBSYSTEM=="usb", TEST=="power/autosuspend", ATTR{power/autosuspend}="2"

# PCI device power management for hybrid graphics
ACTION=="add", SUBSYSTEM=="pci", ATTR{class}=="0x030000", TEST=="power/control", ATTR{power/control}="auto"

# Network device power management
ACTION=="add", SUBSYSTEM=="net", KERNEL=="wl*", RUN+="/usr/bin/iw dev %k set power_save on"

# SATA link power management
ACTION=="add", SUBSYSTEM=="scsi_host", KERNEL=="host*", ATTR{link_power_management_policy}="med_power_with_dipm"